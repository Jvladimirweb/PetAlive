<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>PetAlive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
    .card { max-width: 420px; margin:auto; background:#fff; border-radius: 12px; padding: 16px; box-shadow: 0 4px 10px rgba(0,0,0,.1); text-align:center; }
    img.pet { width:100%; border-radius:10px; }
    .status { margin:10px 0; font-weight:bold; color: green; }
    .status.perdido { color:#d32f2f; }

    button.button, a.button {
      display:block; width:100%;
      margin-top:12px; padding:12px;
      color:#fff; text-decoration:none;
      border-radius:10px; font-weight:bold;
      border:0; cursor:pointer; font-size:16px;
      box-sizing:border-box;
    }

    .btn-alert { background:#ff9800; }
    .btn-manage { background:#111; }
    .btn-home { background:#555; }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center; padding:16px;
      z-index:999;
    }
    .modal{
      width:100%; max-width:420px; background:#fff; border-radius:14px; padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.2); text-align:left;
    }
    .modal h3{ margin:0 0 8px; }
    .modal p{ margin:0 0 12px; color:#444; font-size:14px; }
    .modal input, .modal textarea{
      width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; font-size:16px;
      box-sizing:border-box;
    }
    .modal textarea{ min-height:90px; resize:vertical; }
    .row{ display:flex; gap:10px; margin-top:12px; }
    .row button{ flex:1; }
    .btn-cancel{ background:#eee; color:#111; }
    .btn-go{ background:#111; color:#fff; }
    .hint{ margin-top:10px; font-size:13px; color:#666; }
  </style>

  <script>
    // helper: garante link de imagem direto
    function normalizarFotoUrl(fotoUrl) {
      if (!fotoUrl) return "";
      if (fotoUrl.includes("thumbnail?id=")) return fotoUrl;
      if (fotoUrl.includes("uc?export=view&id=")) {
        return fotoUrl.replace("uc?export=view&id=", "thumbnail?id=") + "&sz=w800";
      }
      return fotoUrl;
    }

    // ===== Modal Avisar PetAlive =====
    function abrirModalAviso(){
      document.getElementById("ondeViu").value = "";
      document.getElementById("quandoViu").value = "";
      document.getElementById("obsViu").value = "";
      document.getElementById("whatsOpcional").value = "";
      document.getElementById("modalAvisoBackdrop").style.display = "flex";
      setTimeout(() => document.getElementById("ondeViu").focus(), 50);
    }
    function fecharModalAviso(){
      document.getElementById("modalAvisoBackdrop").style.display = "none";
    }
    function avisoBackdropClick(e){
      if(e.target && e.target.id === "modalAvisoBackdrop") fecharModalAviso();
    }

    function enviarAvisoWhats(){
      const pet = window.__petAtual;
      if(!pet || !pet.petId){
        alert("Pet inv√°lido.");
        return;
      }

      const onde = (document.getElementById("ondeViu").value || "").trim();
      const quando = (document.getElementById("quandoViu").value || "").trim();
      const obs = (document.getElementById("obsViu").value || "").trim();
      const whats = (document.getElementById("whatsOpcional").value || "").trim();

      if(!onde || !quando){
        alert("Preencha onde e quando viu o pet.");
        return;
      }

      const numeroPetAlive = "5521969876936"; // 55 + DDD + n√∫mero

      const msg =
`üêæ PetAlive - Aviso de pet visto/encontrado

Pet ID: ${pet.petId}
Nome: ${pet.petNome || "-"}
Tipo/Ra√ßa: ${pet.tipo || "-"} / ${pet.raca || "-"}

üìç Onde: ${onde}
üïí Quando: ${quando}
üìù Observa√ß√µes: ${obs || "‚Äî"}

üì≤ Meu WhatsApp (opcional): ${whats || "‚Äî"}
Link: ${location.href}
`;

      const url = `https://wa.me/${numeroPetAlive}?text=${encodeURIComponent(msg)}`;
      window.open(url, "_blank");
      fecharModalAviso();
    }
  </script>
</head>

<body>

<div class="card" id="petCard">
  <p>Carregando dados do pet...</p>
</div>

<!-- Modal Avisar -->
<div class="modal-backdrop" id="modalAvisoBackdrop" onclick="avisoBackdropClick(event)">
  <div class="modal">
    <h3>Avisar a PetAlive</h3>
    <p>Conte rapidamente onde e quando voc√™ viu o pet. Vamos intermediar o contato com o tutor.</p>

    <input id="ondeViu" placeholder="Onde voc√™ viu? (ex: Caxias, perto do mercado)" />
    <input id="quandoViu" style="margin-top:10px" placeholder="Quando? (ex: hoje 14h / ontem √† noite)" />
    <textarea id="obsViu" style="margin-top:10px" placeholder="Observa√ß√µes (coleira, comportamento, etc)"></textarea>
    <input id="whatsOpcional" style="margin-top:10px" placeholder="Seu WhatsApp (opcional)" />

    <div class="row">
      <button class="button btn-cancel" onclick="fecharModalAviso()">Cancelar</button>
      <button class="button btn-go" onclick="enviarAvisoWhats()">Enviar aviso</button>
    </div>

    <div class="hint">N√£o mostramos o contato do tutor para evitar golpes.</div>
  </div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const petIdParam = (params.get("id") || "").trim();

  const SHEET_ID = "1kK-zkAkyYEyF4DCmd73KU-RWtSZuNiNXD3EI1eFr-7c";
  const SHEET_NAME = "P√°gina1";
  const url = `https://opensheet.elk.sh/${SHEET_ID}/${SHEET_NAME}`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const pet = data.find(p => (p.petId || "").trim() === petIdParam);

      if (!pet) {
        document.getElementById("petCard").innerHTML = "<p>Pet n√£o encontrado üò¢</p>";
        return;
      }

      // salva global pro WhatsApp
      window.__petAtual = {
        petId: (pet.petId || "").trim(),
        petNome: pet.petNome || "",
        tipo: pet.tipo || "",
        raca: pet.raca || ""
      };

      const statusAtual = (pet.status && pet.status.trim()) ? pet.status.trim() : "Ativo";
      const foto = normalizarFotoUrl(pet.fotoUrl);
      const statusClass = statusAtual === "Perdido" ? "status perdido" : "status";

      document.getElementById("petCard").innerHTML = `
        ${foto ? `<img class="pet" src="${foto}" alt="Foto do pet">` : ""}
        <h2>${pet.petNome || "-"}</h2>
        <p>${pet.tipo || "-"} ‚Ä¢ ${pet.raca || "-"}</p>

        <p class="${statusClass}">Status: ${statusAtual}</p>

        <button class="button btn-alert" onclick="abrirModalAviso()">
          Avisar a PetAlive
        </button>

        <a class="button btn-home" href="https://petalive.vercel.app">
          Voltar para a Home
        </a>
      `;
    })
    .catch((e) => {
      console.log("Erro fetch:", e);
      document.getElementById("petCard").innerHTML = "<p>Erro ao carregar dados üò¢</p>";
    });
</script>

</body>
</html>
