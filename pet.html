<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>PetAlive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
    .card { max-width: 420px; margin:auto; background:#fff; border-radius: 12px; padding: 16px; box-shadow: 0 4px 10px rgba(0,0,0,.1); text-align:center; }
    img.pet { width:100%; border-radius:10px; }
    .status { margin:10px 0; font-weight:bold; color: green; }
    .status.perdido { color:#d32f2f; }

    button.button, a.button {
      display:block; width:100%;
      margin-top:12px; padding:12px;
      color:#fff; text-decoration:none;
      border-radius:10px; font-weight:bold;
      border:0; cursor:pointer; font-size:16px;
      box-sizing:border-box;
    }

    .btn-alert { background:#ff9800; }
    .btn-tutor { background:#111; }
    .btn-home { background:#555; }

    /* Modal base */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center; padding:16px;
      z-index:999;
    }
    .modal{
      width:100%; max-width:420px; background:#fff; border-radius:14px; padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.2); text-align:left;
    }
    .modal h3{ margin:0 0 8px; }
    .modal p{ margin:0 0 12px; color:#444; font-size:14px; }
    .modal input, .modal textarea{
      width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; font-size:16px;
      box-sizing:border-box;
    }
    .modal textarea{ min-height:90px; resize:vertical; }
    .row{ display:flex; gap:10px; margin-top:12px; }
    .row button{ flex:1; }
    .btn-cancel{ background:#eee; color:#111; }
    .btn-go{ background:#111; color:#fff; }
    .hint{ margin-top:10px; font-size:13px; color:#666; }

    /* Consentimento localiza√ß√£o */
    .consent-wrap{
      margin-top:10px; padding:10px; border:1px solid #eee; border-radius:10px; background:#fafafa;
      font-size:13px; color:#444;
    }
    .consent-line{ display:flex; gap:10px; align-items:flex-start; }
    .consent-line input{ width:auto; margin-top:3px; }
    .loc-status{ margin-top:8px; font-size:12px; color:#666; }
  </style>

  <script>
    function normalize(s){ return (s || "").toString().trim(); }

    // helper: garante link de imagem direto (Google Drive)
    function normalizarFotoUrl(fotoUrl) {
      const u = normalize(fotoUrl);
      if (!u) return "";

      if (u.includes("drive.google.com/uc?") && u.includes("id=")) {
        const id = (u.match(/[?&]id=([^&]+)/) || [])[1];
        if (id) return `https://drive.google.com/thumbnail?id=${id}&sz=w800`;
      }

      if (u.includes("thumbnail?id=")) return u + (u.includes("&sz=") ? "" : "&sz=w800");

      if (u.includes("uc?export=view&id=")) {
        return u.replace("uc?export=view&id=", "thumbnail?id=") + "&sz=w800";
      }

      return u;
    }

    // ===== Avisar PetAlive (WhatsApp) =====
    function abrirModalAviso(){
      document.getElementById("ondeViu").value = "";
      document.getElementById("quandoViu").value = "";
      document.getElementById("obsViu").value = "";
      document.getElementById("whatsOpcional").value = "";

      document.getElementById("locConsent").checked = false;
      window.__geo = null;
      document.getElementById("locStatus").textContent = "Localiza√ß√£o: n√£o compartilhada.";

      document.getElementById("modalAvisoBackdrop").style.display = "flex";
      setTimeout(() => document.getElementById("ondeViu").focus(), 50);
    }
    function fecharModalAviso(){
      document.getElementById("modalAvisoBackdrop").style.display = "none";
    }
    function avisoBackdropClick(e){
      if(e.target && e.target.id === "modalAvisoBackdrop") fecharModalAviso();
    }

    function obterLocalizacaoSeConsentiu(cb){
      const consentiu = document.getElementById("locConsent").checked;

      if(!consentiu){
        window.__geo = null;
        document.getElementById("locStatus").textContent = "Localiza√ß√£o: n√£o compartilhada.";
        if (typeof cb === "function") cb();
        return;
      }

      if(window.__geo && window.__geo.lat && window.__geo.lng){
        document.getElementById("locStatus").textContent =
          `Localiza√ß√£o: capturada (precis√£o ~${window.__geo.acc || "?"}m).`;
        if (typeof cb === "function") cb();
        return;
      }

      const statusEl = document.getElementById("locStatus");

      if(!("geolocation" in navigator)){
        statusEl.textContent = "Localiza√ß√£o: indispon√≠vel neste dispositivo/navegador.";
        window.__geo = null;
        if (typeof cb === "function") cb();
        return;
      }

      statusEl.textContent = "Localiza√ß√£o: solicitando permiss√£o...";

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const acc = Math.round(pos.coords.accuracy || 0);

          window.__geo = { lat, lng, acc };
          statusEl.textContent = `Localiza√ß√£o: capturada (precis√£o ~${acc}m).`;
          if (typeof cb === "function") cb();
        },
        (err) => {
          window.__geo = null;

          let msg = "Localiza√ß√£o: n√£o autorizada.";
          if(err && err.code === 1) msg = "Localiza√ß√£o: permiss√£o negada.";
          if(err && err.code === 2) msg = "Localiza√ß√£o: indispon√≠vel no momento.";
          if(err && err.code === 3) msg = "Localiza√ß√£o: tempo esgotado.";

          statusEl.textContent = msg;
          if (typeof cb === "function") cb();
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    }

    function enviarAvisoWhats(){
      const pet = window.__petAtual;
      if(!pet || !pet.petId){
        alert("Pet inv√°lido.");
        return;
      }

      const onde = (document.getElementById("ondeViu").value || "").trim();
      const quando = (document.getElementById("quandoViu").value || "").trim();
      const obs = (document.getElementById("obsViu").value || "").trim();
      const whats = (document.getElementById("whatsOpcional").value || "").trim();

      if(!onde || !quando){
        alert("Preencha onde e quando viu o pet.");
        return;
      }

      obterLocalizacaoSeConsentiu(() => {
        const numeroPetAlive = "5521969876936"; // 55 + DDD + n√∫mero

        let blocoLocal = "üìç Localiza√ß√£o (opcional): n√£o compartilhada.";
        if(window.__geo && window.__geo.lat && window.__geo.lng){
          const maps = `https://www.google.com/maps?q=${window.__geo.lat},${window.__geo.lng}`;
          blocoLocal =
`üìç Localiza√ß√£o (GPS): ${window.__geo.lat.toFixed(6)}, ${window.__geo.lng.toFixed(6)}
üó∫Ô∏è Mapa: ${maps}
üéØ Precis√£o aprox.: ${window.__geo.acc || "?"}m`;
        }

        const msg =
`üêæ PetAlive - Aviso de pet visto/encontrado

Pet ID: ${pet.petId}
Nome: ${pet.petNome || "-"}
Tipo/Ra√ßa: ${pet.tipo || "-"} / ${pet.raca || "-"}

üìå Onde (relato): ${onde}
üïí Quando: ${quando}
üìù Observa√ß√µes: ${obs || "‚Äî"}

${blocoLocal}

üì≤ Meu WhatsApp (opcional): ${whats || "‚Äî"}
Link: ${location.href}
`;

        const url = `https://wa.me/${numeroPetAlive}?text=${encodeURIComponent(msg)}`;

        try { window.location.href = url; }
        catch(e) { window.open(url, "_blank"); }

        fecharModalAviso();
      });
    }

    // ===== Tutor (token -> manage) =====
    function abrirModalTutor(){
      document.getElementById("tokenInput").value = "";
      document.getElementById("modalTutorBackdrop").style.display = "flex";
      setTimeout(() => document.getElementById("tokenInput").focus(), 50);
    }
    function fecharModalTutor(){
      document.getElementById("modalTutorBackdrop").style.display = "none";
    }
    function tutorBackdropClick(e){
      if(e.target && e.target.id === "modalTutorBackdrop") fecharModalTutor();
    }
    function irParaManage(){
      const pet = window.__petAtual;
      const token = (document.getElementById("tokenInput").value || "").trim();
      if(!pet || !pet.petId){ alert("Pet inv√°lido."); return; }
      if(!token){ alert("Digite o token recebido por SMS."); return; }

      const url = `https://petalive.vercel.app/manage.html?id=${encodeURIComponent(pet.petId)}&t=${encodeURIComponent(token)}`;
      window.location.href = url;
    }
  </script>
</head>

<body>

<div class="card" id="petCard">
  <p>Carregando dados do pet...</p>
</div>

<!-- Modal Avisar -->
<div class="modal-backdrop" id="modalAvisoBackdrop" onclick="avisoBackdropClick(event)">
  <div class="modal">
    <h3>Avisar a PetAlive</h3>
    <p>Conte rapidamente onde e quando voc√™ viu o pet. Vamos intermediar o contato com o tutor.</p>

    <input id="ondeViu" placeholder="Onde voc√™ viu? (ex: Caxias, perto do mercado)" />
    <input id="quandoViu" style="margin-top:10px" placeholder="Quando? (ex: hoje 14h / ontem √† noite)" />
    <textarea id="obsViu" style="margin-top:10px" placeholder="Observa√ß√µes (coleira, comportamento, etc)"></textarea>
    <input id="whatsOpcional" style="margin-top:10px" placeholder="Seu WhatsApp (opcional)" />

    <div class="consent-wrap">
      <div class="consent-line">
        <input type="checkbox" id="locConsent" onchange="obterLocalizacaoSeConsentiu()">
        <div>
          <b>Compartilhar minha localiza√ß√£o (opcional)</b><br>
          Ao marcar, voc√™ autoriza enviar sua localiza√ß√£o GPS <u>apenas</u> neste aviso, para ajudar o tutor a encontrar o pet.
        </div>
      </div>
      <div id="locStatus" class="loc-status">Localiza√ß√£o: n√£o compartilhada.</div>
    </div>

    <div class="row">
      <button class="button btn-cancel" onclick="fecharModalAviso()">Cancelar</button>
      <button class="button btn-go" onclick="enviarAvisoWhats()">Enviar aviso</button>
    </div>

    <div class="hint">N√£o mostramos o contato do tutor para evitar golpes.</div>
  </div>
</div>

<!-- Modal Tutor -->
<div class="modal-backdrop" id="modalTutorBackdrop" onclick="tutorBackdropClick(event)">
  <div class="modal">
    <h3>√Årea do tutor</h3>
    <p>Digite o <b>token</b> recebido por SMS para gerenciar o status do seu pet.</p>

    <input id="tokenInput" placeholder="Cole o token aqui" autocomplete="off" />

    <div class="row">
      <button class="button btn-cancel" onclick="fecharModalTutor()">Cancelar</button>
      <button class="button btn-go" onclick="irParaManage()">Continuar</button>
    </div>

    <div class="hint">O token √© pessoal e expira. Guarde em local seguro.</div>
  </div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const petIdParam = (params.get("id") || "").trim();

  // ‚úÖ Coloque aqui:
  const SUPABASE_URL = "https://bddekzqqrchvzuctgyvx.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkZGVrenFxcmNodnp1Y3RneXZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzUwMjYsImV4cCI6MjA4NzQ1MTAyNn0.yYOk5JFIzMWtjpn9tqZSoDuf1tgJH7piTVPhubT6pzw";

  async function carregarPet(){
    if(!petIdParam){
      document.getElementById("petCard").innerHTML = "<p>Pet n√£o encontrado üò¢</p>";
      return;
    }

    try{
      const url =
        `${SUPABASE_URL}/rest/v1/public_pets?` +
        `pet_id=eq.${encodeURIComponent(petIdParam)}` +
        `&select=pet_id,pet_nome,tipo,raca,foto_url,status,data_cadastro` +
        `&limit=1`;

      const r = await fetch(url, {
        method: "GET",
        headers: {
          headers: {
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
            "Accept": "application/json"
          }
        }
      });

      const text = await r.text();
      if(!r.ok) throw new Error(`HTTP ${r.status}: ${text.slice(0,200)}`);

      const data = JSON.parse(text);
      const pet = Array.isArray(data) ? data[0] : data;

      if (!pet || !normalize(pet.pet_id)) {
        document.getElementById("petCard").innerHTML = "<p>Pet n√£o encontrado üò¢</p>";
        return;
      }

      const statusAtual = normalize(pet.status) || "Ativo";
      const foto = normalizarFotoUrl(pet.foto_url);
      const statusClass = statusAtual === "Perdido" ? "status perdido" : "status";

      window.__petAtual = {
        petId: normalize(pet.pet_id),
        petNome: pet.pet_nome || "",
        tipo: pet.tipo || "",
        raca: pet.raca || "",
        status: statusAtual
      };

      document.getElementById("petCard").innerHTML = `
        ${foto ? `<img class="pet" src="${foto}" alt="Foto do pet">` : ""}
        <h2>${pet.pet_nome || "-"}</h2>
        <p>${pet.tipo || "-"} ‚Ä¢ ${pet.raca || "-"}</p>

        <p class="${statusClass}">Status: ${statusAtual}</p>

        <button class="button btn-alert" onclick="abrirModalAviso()">Avisar a PetAlive</button>
        <button class="button btn-tutor" onclick="abrirModalTutor()">Sou o tutor ‚Ä¢ Gerenciar status</button>

        <a class="button btn-home" href="https://petalive.vercel.app">Voltar para a Home</a>
      `;
    } catch(e){
      console.log("Erro fetch:", e);
      document.getElementById("petCard").innerHTML = "<p>Erro ao carregar dados üò¢</p>";
    }
  }

  carregarPet();
</script>

</body>
</html>
