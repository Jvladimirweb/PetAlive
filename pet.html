<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>PetAlive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f8; padding: 20px; }
    .card { max-width: 420px; margin: auto; background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 4px 10px rgba(0,0,0,.1); text-align: center; }
    img.pet { width: 100%; border-radius: 10px; }
    .status { margin: 10px 0; font-weight: bold; color: green; }
    .status.perdido { color: #d32f2f; }

    a.button, button.button {
      display: block; width: 100%;
      margin-top: 12px; padding: 12px;
      color: white; text-decoration: none;
      border-radius: 8px; font-weight: bold;
      border: 0; cursor: pointer; font-size: 16px;
      box-sizing: border-box;
    }

    .btn-manage { background: #111; }
    .btn-alert { background: #ff9800; }
    .btn-home { background:#555; margin-top:10px; }

    /* Modal base */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center; padding:16px;
      z-index: 999;
    }
    .modal{
      width:100%; max-width:420px; background:#fff; border-radius:14px; padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.2); text-align:left;
    }
    .modal h3{ margin:0 0 8px; }
    .modal p{ margin:0 0 12px; color:#444; font-size:14px; }
    .modal input, .modal textarea{
      width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; font-size:16px;
      box-sizing:border-box;
    }
    .modal textarea{ min-height: 90px; resize: vertical; }
    .row{ display:flex; gap:10px; margin-top:12px; }
    .row button{ flex:1; }
    .btn-cancel{ background:#eee; color:#111; }
    .btn-go{ background:#111; color:#fff; }
    .hint{ margin-top:10px; font-size:13px; color:#666; }
  </style>

  <script>
    // ====== CONFIG: Avisar PetAlive (n8n webhook) ======
    // Coloque aqui o webhook do WORKFLOW de "Avisar PetAlive"
    // Exemplo: https://SEU_NGROK.ngrok-free.app/webhook/pet-alert
    const ALERT_WEBHOOK_URL = "https://SEU_NGROK.ngrok-free.app/webhook/pet-alert";

    function normalizarFotoUrl(fotoUrl) {
      if (!fotoUrl) return "";
      if (fotoUrl.includes("thumbnail?id=")) return fotoUrl;
      if (fotoUrl.includes("uc?export=view&id=")) {
        return fotoUrl.replace("uc?export=view&id=", "thumbnail?id=") + "&sz=w800";
      }
      return fotoUrl;
    }

    // ====== Modal Tutor (token) ======
    function abrirModalToken(petId){
      window.__petIdManage = petId;
      const backdrop = document.getElementById("modalTutorBackdrop");
      const input = document.getElementById("tokenInput");
      input.value = "";
      backdrop.style.display = "flex";
      setTimeout(() => input.focus(), 50);
    }
    function fecharModalToken(){
      document.getElementById("modalTutorBackdrop").style.display = "none";
    }
    function irParaManage(){
      const petId = window.__petIdManage;
      const token = (document.getElementById("tokenInput").value || "").trim();
      if(!petId) { alert("PetId inv√°lido."); return; }
      if(!token) { alert("Digite o token recebido por SMS."); return; }

      const url = `https://petalive.vercel.app/manage.html?id=${encodeURIComponent(petId)}&t=${encodeURIComponent(token)}`;
      window.location.href = url;
    }
    function tutorBackdropClick(e){
      if(e.target && e.target.id === "modalTutorBackdrop") fecharModalToken();
    }

    // ====== Modal Avisar PetAlive ======
    function abrirModalAviso(pet){
      window.__petAviso = pet;
      document.getElementById("ondeViu").value = "";
      document.getElementById("quandoViu").value = "";
      document.getElementById("obsViu").value = "";
      document.getElementById("whatsOpcional").value = "";
      document.getElementById("modalAvisoBackdrop").style.display = "flex";
      setTimeout(() => document.getElementById("ondeViu").focus(), 50);
    }
    function fecharModalAviso(){
      document.getElementById("modalAvisoBackdrop").style.display = "none";
    }
    function avisoBackdropClick(e){
      if(e.target && e.target.id === "modalAvisoBackdrop") fecharModalAviso();
    }

    async function enviarAviso() {
      const onde = document.getElementById("ondeViu").value;
      const quando = document.getElementById("quandoViu").value;
      const obs = document.getElementById("observacoes").value;
      const contato = document.getElementById("seuContato").value;
    
      if (!onde || !quando) {
        alert("Preencha onde e quando viu o pet.");
        return;
      }
    
      const numeroPetAlive = "5521969876936"; // 55 + DDD + n√∫mero
    
      const mensagem = `
    Aviso sobre pet encontrado:
    
    üìç Onde: ${onde}
    üìÖ Quando: ${quando}
    üìù Observa√ß√µes: ${obs || "N√£o informado"}
    üìû Meu contato: ${contato || "N√£o informado"}
      `;
    
      const url = `https://wa.me/${numeroPetAlive}?text=${encodeURIComponent(mensagem)}`;
    
      window.open(url, "_blank");
    }


      const payload = {
        petId: pet.petId,
        petNome: pet.petNome || "",
        tipo: pet.tipo || "",
        raca: pet.raca || "",
        status: pet.status || "",
        ondeViu: (document.getElementById("ondeViu").value || "").trim(),
        quandoViu: (document.getElementById("quandoViu").value || "").trim(),
        observacoes: (document.getElementById("obsViu").value || "").trim(),
        whatsapp: (document.getElementById("whatsOpcional").value || "").trim(),
        pageUrl: window.location.href
      };

      if(!payload.ondeViu || !payload.quandoViu){
        alert("Preencha: onde viu e quando viu.");
        return;
      }

      try{
        const res = await fetch(ALERT_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));
        if(!res.ok || data.ok !== true){
          console.log("Resposta alerta:", res.status, data);
          alert("N√£o foi poss√≠vel enviar o aviso agora.");
          return;
        }

        fecharModalAviso();
        alert("Aviso enviado. A PetAlive vai analisar e te retornar se necess√°rio.");
      }catch(e){
        console.log(e);
        alert("Erro de conex√£o ao enviar aviso.");
      }
    }
  </script>
</head>

<body>

<div class="card" id="petCard">
  <p>Carregando dados do pet...</p>
</div>

<!-- Modal Tutor -->
<div class="modal-backdrop" id="modalTutorBackdrop" onclick="tutorBackdropClick(event)">
  <div class="modal">
    <h3>√Årea do tutor</h3>
    <p>Digite o <b>token</b> recebido por SMS para gerenciar o status do seu pet.</p>
    <input id="tokenInput" placeholder="Ex: bb9qy6dwckorl4xe61gcvc" autocomplete="off" />
    <div class="row">
      <button class="button btn-cancel" onclick="fecharModalToken()">Cancelar</button>
      <button class="button btn-go" onclick="irParaManage()">Continuar</button>
    </div>
    <div class="hint">Sem token? Pe√ßa um novo link via PetAlive.</div>
  </div>
</div>

<!-- Modal Avisar PetAlive -->
<div class="modal-backdrop" id="modalAvisoBackdrop" onclick="avisoBackdropClick(event)">
  <div class="modal">
    <h3>Avisar a PetAlive</h3>
    <p>Conte rapidamente onde e quando voc√™ viu o pet. A PetAlive intermedia o contato com o tutor.</p>

    <input id="ondeViu" placeholder="Onde voc√™ viu? (ex: Rua X, perto do mercado)" />
    <input id="quandoViu" style="margin-top:10px" placeholder="Quando? (ex: hoje 14h / ontem √† noite)" />
    <textarea id="obsViu" style="margin-top:10px" placeholder="Observa√ß√µes (corre atr√°s de carros, estava com coleira, etc)"></textarea>
    <input id="whatsOpcional" style="margin-top:10px" placeholder="Seu WhatsApp (opcional)" />

    <div class="row">
      <button class="button btn-cancel" onclick="fecharModalAviso()">Cancelar</button>
      <button onclick="enviarAviso()">Enviar aviso</button>
    </div>

    <div class="hint">N√£o mostramos o contato do tutor para evitar golpes.</div>
  </div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const petIdParam = (params.get("id") || "").trim();

  const SHEET_ID = "1kK-zkAkyYEyF4DCmd73KU-RWtSZuNiNXD3EI1eFr-7c";
  const SHEET_NAME = "P√°gina1";
  const url = `https://opensheet.elk.sh/${SHEET_ID}/${SHEET_NAME}`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const pet = data.find(p => (p.petId || "").trim() === petIdParam);

      if (!pet) {
        document.getElementById("petCard").innerHTML = "<p>Pet n√£o encontrado üò¢</p>";
        return;
      }

      const statusAtual = (pet.status && pet.status.trim()) ? pet.status.trim() : "Ativo";
      const foto = normalizarFotoUrl(pet.fotoUrl);
      const statusClass = statusAtual === "Perdido" ? "status perdido" : "status";

      document.getElementById("petCard").innerHTML = `
        ${foto ? `<img class="pet" src="${foto}" alt="Foto do pet">` : ""}
        <h2>${pet.petNome || "-"}</h2>
        <p>${pet.tipo || "-"} ‚Ä¢ ${pet.raca || "-"}</p>

        <p class="${statusClass}">Status: ${statusAtual}</p>

        <button class="button btn-alert" onclick='abrirModalAviso(${JSON.stringify({
          petId: pet.petId,
          petNome: pet.petNome || "",
          tipo: pet.tipo || "",
          raca: pet.raca || "",
          status: statusAtual
        }).replace(/'/g, "\\'")})'>
          Avisar a PetAlive
        </button>

        <button class="button btn-manage" onclick="abrirModalToken('${pet.petId}')">
          Sou o tutor ‚Ä¢ Gerenciar status
        </button>

        <a class="button btn-home" href="https://petalive.vercel.app">
          Voltar para a Home
        </a>
      `;
    })
    .catch(() => {
      document.getElementById("petCard").innerHTML = "<p>Erro ao carregar dados üò¢</p>";
    });
</script>

</body>
</html>
